{% extends 'base.html' %}
{% load static %}

{% block title %}–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤—ã—â–µ–ª–∞—á–∏–≤–∞–Ω–∏—è - Metallurgy Lab{% endblock %}

{% block content %}
<div class="pt-24 pb-16 px-4 max-w-7xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-12">
        <h1 class="text-4xl md:text-5xl font-extrabold mb-4 bg-gradient-to-r from-blue-500 via-purple-600 to-amber-500 bg-clip-text text-transparent">
            üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤—ã—â–µ–ª–∞—á–∏–≤–∞–Ω–∏—è
        </h1>
        <p class="text-xl text-slate-300 max-w-3xl mx-auto">
            –†–∞—Å—á–µ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞ –∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø—Ä–∏ –∫–∏—Å–ª–æ—Ç–Ω–æ–º –≤—ã—â–µ–ª–∞—á–∏–≤–∞–Ω–∏–∏ –º–æ–ª–∏–±–¥–µ–Ω–∏—Ç–æ–≤–æ–≥–æ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç–∞
        </p>
    </div>

    <!-- Main Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <!-- Left Column - Input Form -->
        <div class="space-y-6">
            
            <!-- –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç -->
            <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-2xl p-6">
                <h2 class="text-xl font-bold text-slate-100 mb-4 flex items-center gap-2">
                    <span class="text-2xl">‚öóÔ∏è</span>
                    –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç
                </h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">–ú–∞—Å—Å–∞ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç–∞ (–≥)</label>
                        <input type="number" id="concentrate_mass" step="0.01" 
                               class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 text-slate-100 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent transition-all"
                               placeholder="50" value="50">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Mo (%)</label>
                            <input type="number" id="initial_mo" step="0.01" 
                                   class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 text-slate-100 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                                   placeholder="20.3" value="20.3">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Cu (%)</label>
                            <input type="number" id="initial_cu" step="0.01" 
                                   class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 text-slate-100 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                                   placeholder="1.99" value="1.99">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Fe (%)</label>
                            <input type="number" id="initial_fe" step="0.01" 
                                   class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 text-slate-100 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                                   placeholder="2.33" value="2.33">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Si (%)</label>
                            <input type="number" id="initial_si" step="0.01" 
                                   class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 text-slate-100 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                                   placeholder="2.47" value="2.47">
                        </div>
                    </div>
                </div>
            </div>

            <!-- –£—Å–ª–æ–≤–∏—è –≤—ã—â–µ–ª–∞—á–∏–≤–∞–Ω–∏—è -->
            <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-2xl p-6">
                <h2 class="text-xl font-bold text-slate-100 mb-4 flex items-center gap-2">
                    <span class="text-2xl">üå°Ô∏è</span>
                    –£—Å–ª–æ–≤–∏—è –≤—ã—â–µ–ª–∞—á–∏–≤–∞–Ω–∏—è
                </h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">–¢–∏–ø –∫–∏—Å–ª–æ—Ç—ã</label>
                        <select id="acid_type" 
                                class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 text-slate-100 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                            {% for code, name in acid_types %}
                            <option value="{{ code }}">{{ name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div id="hno3_block">
                        <label class="block text-sm font-medium text-slate-300 mb-2">–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è HNO‚ÇÉ (–≥/–ª)</label>
                        <input type="number" id="hno3_concentration" step="1" 
                               class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 text-slate-100 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                               placeholder="50" value="50">
                    </div>
                    
                    <div id="h2so4_block" style="display: none;">
                        <label class="block text-sm font-medium text-slate-300 mb-2">–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è H‚ÇÇSO‚ÇÑ (–≥/–ª)</label>
                        <input type="number" id="h2so4_concentration" step="1" 
                               class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 text-slate-100 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                               placeholder="200" value="200">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">–û–±—ä–µ–º —Ä–∞—Å—Ç–≤–æ—Ä–∞ (–º–ª)</label>
                            <input type="number" id="solution_volume" step="1" 
                                   class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 text-slate-100 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                                   placeholder="300" value="300">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)</label>
                            <input type="number" id="temperature" step="1" 
                                   class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 text-slate-100 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                                   placeholder="95" value="95">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—á)</label>
                            <input type="number" id="duration" step="0.1" 
                                   class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 text-slate-100 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                                   placeholder="4" value="4">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">–°–∫–æ—Ä–æ—Å—Ç—å –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏—è (–æ–±/–º–∏–Ω)</label>
                            <input type="number" id="stirring_speed" step="10" 
                                   class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 text-slate-100 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                                   placeholder="300" value="300">
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-3 p-4 bg-slate-900/50 rounded-lg">
                        <input type="checkbox" id="has_oxygen" class="w-5 h-5 rounded border-slate-700 bg-slate-900 text-amber-500 focus:ring-2 focus:ring-amber-500">
                        <label for="has_oxygen" class="text-slate-300 font-medium cursor-pointer">–ü—Ä–æ–¥—É–≤–∫–∞ –∫–∏—Å–ª–æ—Ä–æ–¥–æ–º</label>
                    </div>
                    
                    <div id="oxygen_block" style="display: none;">
                        <label class="block text-sm font-medium text-slate-300 mb-2">–†–∞—Å—Ö–æ–¥ O‚ÇÇ (–¥–º¬≥/–º–∏–Ω)</label>
                        <input type="number" id="oxygen_flow" step="0.01" 
                               class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-3 text-slate-100 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                               placeholder="0.85" value="0.85">
                    </div>
                </div>
            </div>

            <!-- –ü—Ä–æ–¥—É–∫—Ç—ã –≤—ã—â–µ–ª–∞—á–∏–≤–∞–Ω–∏—è -->
            <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-2xl p-6">
                <h2 class="text-xl font-bold text-slate-100 mb-4 flex items-center gap-2">
                    <span class="text-2xl">üìä</span>
                    –ü—Ä–æ–¥—É–∫—Ç—ã –≤—ã—â–µ–ª–∞—á–∏–≤–∞–Ω–∏—è
                </h2>
                
                <div class="space-y-6">
                    <!-- –ö–µ–∫ -->
                    <div class="bg-red-500/10 border border-red-500/30 rounded-xl p-4">
                        <h3 class="font-bold text-red-400 mb-3">–ö–µ–∫</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">–ú–∞—Å—Å–∞ (–≥)</label>
                                <input type="number" id="cake_mass" step="0.01" 
                                       class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-2 text-slate-100 focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent"
                                       placeholder="43.5">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs text-slate-400 mb-1">Mo (%)</label>
                                    <input type="number" id="cake_mo" step="0.01" 
                                           class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-red-500"
                                           placeholder="18.86">
                                </div>
                                <div>
                                    <label class="block text-xs text-slate-400 mb-1">Cu (%)</label>
                                    <input type="number" id="cake_cu" step="0.01" 
                                           class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-red-500"
                                           placeholder="0.508">
                                </div>
                                <div>
                                    <label class="block text-xs text-slate-400 mb-1">Fe (%)</label>
                                    <input type="number" id="cake_fe" step="0.01" 
                                           class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-red-500"
                                           placeholder="0.611">
                                </div>
                                <div>
                                    <label class="block text-xs text-slate-400 mb-1">Si (%)</label>
                                    <input type="number" id="cake_si" step="0.01" 
                                           class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-red-500"
                                           placeholder="1.74">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- –†–∞—Å—Ç–≤–æ—Ä -->
                    <div class="bg-green-500/10 border border-green-500/30 rounded-xl p-4">
                        <h3 class="font-bold text-green-400 mb-3">–†–∞—Å—Ç–≤–æ—Ä (—Ñ–∏–ª—å—Ç—Ä–∞—Ç)</h3>
                        <div class="space-y-3">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs text-slate-400 mb-1">Mo (–≥/–ª)</label>
                                    <input type="number" id="solution_mo" step="0.01" 
                                           class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-green-500"
                                           placeholder="6.5">
                                </div>
                                <div>
                                    <label class="block text-xs text-slate-400 mb-1">Cu (–≥/–ª)</label>
                                    <input type="number" id="solution_cu" step="0.01" 
                                           class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-green-500"
                                           placeholder="2.58">
                                </div>
                                <div>
                                    <label class="block text-xs text-slate-400 mb-1">Fe (–≥/–ª)</label>
                                    <input type="number" id="solution_fe" step="0.01" 
                                           class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-green-500"
                                           placeholder="3.01">
                                </div>
                                <div>
                                    <label class="block text-xs text-slate-400 mb-1">Si (–≥/–ª)</label>
                                    <input type="number" id="solution_si" step="0.01" 
                                           class="w-full bg-slate-900/50 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-green-500"
                                           placeholder="1.61">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ -->
            <button onclick="calculateLeaching()" 
                    class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 hover:shadow-2xl flex items-center justify-center gap-2">
                <span class="text-xl">üßÆ</span>
                <span>–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –±–∞–ª–∞–Ω—Å</span>
            </button>
        </div>

        <!-- Right Column - Results -->
        <div class="space-y-6">
            
            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã (—Å–∫—Ä—ã—Ç—ã –¥–æ —Ä–∞—Å—á–µ—Ç–∞) -->
            <div id="resultsContainer" style="display: none;">
                
                <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ -->
                <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-2xl p-6">
                    <h2 class="text-xl font-bold text-slate-100 mb-4 flex items-center gap-2">
                        <span class="text-2xl">üìà</span>
                        –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ Mo
                    </h2>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-green-500/20 border border-green-500/40 rounded-xl p-4 text-center">
                            <div class="text-sm text-green-300 mb-1">–í —Ä–∞—Å—Ç–≤–æ—Ä</div>
                            <div class="text-4xl font-extrabold text-green-400" id="mo_to_solution">--</div>
                        </div>
                        <div class="bg-red-500/20 border border-red-500/40 rounded-xl p-4 text-center">
                            <div class="text-sm text-red-300 mb-1">–í –∫–µ–∫</div>
                            <div class="text-4xl font-extrabold text-red-400" id="mo_to_cake">--</div>
                        </div>
                    </div>
                </div>

                <!-- –ú–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å -->
                <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-2xl p-6">
                    <h2 class="text-xl font-bold text-slate-100 mb-4 flex items-center gap-2">
                        <span class="text-2xl">‚öñÔ∏è</span>
                        –ú–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å
                    </h2>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between items-center p-3 bg-slate-900/50 rounded-lg">
                            <span class="text-slate-300">–í—ã—Ö–æ–¥ –∫–µ–∫–∞:</span>
                            <span class="font-bold text-amber-400" id="cake_yield">--%</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-slate-900/50 rounded-lg">
                            <span class="text-slate-300">–¢:–ñ:</span>
                            <span class="font-bold text-amber-400" id="solid_liquid_ratio">--</span>
                        </div>
                    </div>
                </div>

                <!-- –¢–∞–±–ª–∏—Ü–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏–π -->
                <div class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-2xl p-6">
                    <h2 class="text-xl font-bold text-slate-100 mb-4">–ò–∑–≤–ª–µ—á–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (%)</h2>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-slate-700">
                                    <th class="text-left py-2 px-3 text-slate-300">–≠–ª–µ–º–µ–Ω—Ç</th>
                                    <th class="text-center py-2 px-3 text-green-400">–í —Ä–∞—Å—Ç–≤–æ—Ä</th>
                                    <th class="text-center py-2 px-3 text-red-400">–í –∫–µ–∫</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-800">
                                <tr>
                                    <td class="py-2 px-3 font-semibold text-slate-100">Mo</td>
                                    <td class="text-center py-2 px-3 text-green-300" id="mo_sol_extract">--</td>
                                    <td class="text-center py-2 px-3 text-red-300" id="mo_cake_extract">--</td>
                                </tr>
                                <tr>
                                    <td class="py-2 px-3 font-semibold text-slate-100">Cu</td>
                                    <td class="text-center py-2 px-3 text-green-300" id="cu_sol_extract">--</td>
                                    <td class="text-center py-2 px-3 text-red-300" id="cu_cake_extract">--</td>
                                </tr>
                                <tr>
                                    <td class="py-2 px-3 font-semibold text-slate-100">Fe</td>
                                    <td class="text-center py-2 px-3 text-green-300" id="fe_sol_extract">--</td>
                                    <td class="text-center py-2 px-3 text-red-300" id="fe_cake_extract">--</td>
                                </tr>
                                <tr>
                                    <td class="py-2 px-3 font-semibold text-slate-100">Si</td>
                                    <td class="text-center py-2 px-3 text-green-300" id="si_sol_extract">--</td>
                                    <td class="text-center py-2 px-3 text-red-300" id="si_cake_extract">--</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è -->
                <button onclick="saveTest()" 
                        class="w-full bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-700 hover:to-orange-700 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 hover:shadow-2xl flex items-center justify-center gap-2">
                    <span class="text-xl">üíæ</span>
                    <span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ—Å—Ç</span>
                </button>

                <div id="saveStatus" class="text-center text-sm"></div>
            </div>

            <!-- Placeholder –¥–æ —Ä–∞—Å—á–µ—Ç–∞ -->
            <div id="noResults" class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-2xl p-12 text-center">
                <div class="text-6xl mb-4">üßÆ</div>
                <h3 class="text-2xl font-bold text-slate-200 mb-2">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ</h3>
                <p class="text-slate-400">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤—ã—â–µ–ª–∞—á–∏–≤–∞–Ω–∏—è –∏ –Ω–∞–∂–º–∏—Ç–µ "–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –±–∞–ª–∞–Ω—Å"</p>
            </div>
        </div>
    </div>
</div>

{% csrf_token %}

<script>
// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–ª–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∫–∏—Å–ª–æ—Ç—ã
document.getElementById('acid_type').addEventListener('change', function() {
    const acidType = this.value;
    const hno3Block = document.getElementById('hno3_block');
    const h2so4Block = document.getElementById('h2so4_block');
    
    if (acidType === 'hno3') {
        hno3Block.style.display = 'block';
        h2so4Block.style.display = 'none';
    } else if (acidType === 'h2so4') {
        hno3Block.style.display = 'none';
        h2so4Block.style.display = 'block';
    } else if (acidType === 'mixed') {
        hno3Block.style.display = 'block';
        h2so4Block.style.display = 'block';
    }
});

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –±–ª–æ–∫–∞ –∫–∏—Å–ª–æ—Ä–æ–¥–∞
document.getElementById('has_oxygen').addEventListener('change', function() {
    document.getElementById('oxygen_block').style.display = this.checked ? 'block' : 'none';
});

// –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞
async function calculateLeaching() {
    const data = {
        concentrate_mass: parseFloat(document.getElementById('concentrate_mass').value),
        initial_mo: parseFloat(document.getElementById('initial_mo').value),
        initial_cu: parseFloat(document.getElementById('initial_cu').value),
        initial_fe: parseFloat(document.getElementById('initial_fe').value),
        initial_si: parseFloat(document.getElementById('initial_si').value),
        acid_type: document.getElementById('acid_type').value,
        hno3_concentration: document.getElementById('hno3_concentration').value ? parseFloat(document.getElementById('hno3_concentration').value) : null,
        h2so4_concentration: document.getElementById('h2so4_concentration').value ? parseFloat(document.getElementById('h2so4_concentration').value) : null,
        solution_volume: parseFloat(document.getElementById('solution_volume').value),
        temperature: parseFloat(document.getElementById('temperature').value),
        duration: parseFloat(document.getElementById('duration').value),
        stirring_speed: parseFloat(document.getElementById('stirring_speed').value),
        has_oxygen: document.getElementById('has_oxygen').checked,
        oxygen_flow: document.getElementById('oxygen_flow').value ? parseFloat(document.getElementById('oxygen_flow').value) : null,
        cake_mass: parseFloat(document.getElementById('cake_mass').value),
        cake_mo: parseFloat(document.getElementById('cake_mo').value),
        cake_cu: parseFloat(document.getElementById('cake_cu').value),
        cake_fe: parseFloat(document.getElementById('cake_fe').value),
        cake_si: parseFloat(document.getElementById('cake_si').value),
        solution_mo: parseFloat(document.getElementById('solution_mo').value),
        solution_cu: parseFloat(document.getElementById('solution_cu').value),
        solution_fe: parseFloat(document.getElementById('solution_fe').value),
        solution_si: parseFloat(document.getElementById('solution_si').value),
    };

    try {
        const response = await fetch('{% url "molybdenum:leaching_calculator" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            displayResults(result.results);
            window.currentResults = result.results;
        } else {
            alert('–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞: ' + (result.error || JSON.stringify(result.errors)));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ');
    }
}

function displayResults(results) {
    document.getElementById('resultsContainer').style.display = 'block';
    document.getElementById('noResults').style.display = 'none';

    // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ Mo
    document.getElementById('mo_to_solution').textContent = results.extractions.mo_to_solution.toFixed(1) + '%';
    document.getElementById('mo_to_cake').textContent = results.extractions.mo_to_cake.toFixed(1) + '%';

    // –ë–∞–ª–∞–Ω—Å
    document.getElementById('cake_yield').textContent = results.cake_yield.toFixed(1) + '%';
    document.getElementById('solid_liquid_ratio').textContent = results.solid_liquid_ratio;

    // –¢–∞–±–ª–∏—Ü–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏–π
    document.getElementById('mo_sol_extract').textContent = results.extractions.mo_to_solution.toFixed(1) + '%';
    document.getElementById('mo_cake_extract').textContent = results.extractions.mo_to_cake.toFixed(1) + '%';
    document.getElementById('cu_sol_extract').textContent = results.extractions.cu_to_solution.toFixed(1) + '%';
    document.getElementById('cu_cake_extract').textContent = results.extractions.cu_to_cake.toFixed(1) + '%';
    document.getElementById('fe_sol_extract').textContent = results.extractions.fe_to_solution.toFixed(1) + '%';
    document.getElementById('fe_cake_extract').textContent = results.extractions.fe_to_cake.toFixed(1) + '%';
    document.getElementById('si_sol_extract').textContent = results.extractions.si_to_solution.toFixed(1) + '%';
    document.getElementById('si_cake_extract').textContent = results.extractions.si_to_cake.toFixed(1) + '%';
}

async function saveTest() {
    const data = {
        concentrate_mass: parseFloat(document.getElementById('concentrate_mass').value),
        initial_mo: parseFloat(document.getElementById('initial_mo').value),
        initial_cu: parseFloat(document.getElementById('initial_cu').value),
        initial_fe: parseFloat(document.getElementById('initial_fe').value),
        initial_si: parseFloat(document.getElementById('initial_si').value),
        acid_type: document.getElementById('acid_type').value,
        hno3_concentration: document.getElementById('hno3_concentration').value ? parseFloat(document.getElementById('hno3_concentration').value) : null,
        h2so4_concentration: document.getElementById('h2so4_concentration').value ? parseFloat(document.getElementById('h2so4_concentration').value) : null,
        solution_volume: parseFloat(document.getElementById('solution_volume').value),
        temperature: parseFloat(document.getElementById('temperature').value),
        duration: parseFloat(document.getElementById('duration').value),
        stirring_speed: parseFloat(document.getElementById('stirring_speed').value),
        has_oxygen: document.getElementById('has_oxygen').checked,
        oxygen_flow: document.getElementById('oxygen_flow').value ? parseFloat(document.getElementById('oxygen_flow').value) : null,
        cake_mass: parseFloat(document.getElementById('cake_mass').value),
        cake_mo: parseFloat(document.getElementById('cake_mo').value),
        cake_cu: parseFloat(document.getElementById('cake_cu').value),
        cake_fe: parseFloat(document.getElementById('cake_fe').value),
        cake_si: parseFloat(document.getElementById('cake_si').value),
        solution_mo: parseFloat(document.getElementById('solution_mo').value),
        solution_cu: parseFloat(document.getElementById('solution_cu').value),
        solution_fe: parseFloat(document.getElementById('solution_fe').value),
        solution_si: parseFloat(document.getElementById('solution_si').value),
        save_test: true
    };

    try {
        const response = await fetch('{% url "molybdenum:leaching_calculator" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success && result.results.saved) {
            document.getElementById('saveStatus').innerHTML = `
                <div class="bg-green-500/20 border border-green-500/40 rounded-lg p-3 mt-4">
                    <span class="text-green-400 font-semibold">‚úÖ –¢–µ—Å—Ç ‚Ññ${result.results.test_number} —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!</span>
                </div>
            `;
            
            // –ß–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–ø–∏—Å–∫—É —Ç–µ—Å—Ç–æ–≤
            setTimeout(() => {
                if (confirm('–ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–ø–∏—Å–∫—É —Ç–µ—Å—Ç–æ–≤ –≤—ã—â–µ–ª–∞—á–∏–≤–∞–Ω–∏—è?')) {
                    window.location.href = '{% url "molybdenum:leaching_tests" %}';
                }
            }, 1500);
        } else {
            alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
    }
}

// –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–∑ –û–ø—ã—Ç–∞ ‚Ññ1 (–¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏)
function loadExample1() {
    document.getElementById('concentrate_mass').value = 50;
    document.getElementById('initial_mo').value = 20.3;
    document.getElementById('initial_cu').value = 1.99;
    document.getElementById('initial_fe').value = 2.33;
    document.getElementById('initial_si').value = 2.47;
    document.getElementById('acid_type').value = 'hno3';
    document.getElementById('hno3_concentration').value = 50;
    document.getElementById('solution_volume').value = 300;
    document.getElementById('temperature').value = 95;
    document.getElementById('duration').value = 4;
    document.getElementById('stirring_speed').value = 300;
    document.getElementById('has_oxygen').checked = false;
    document.getElementById('cake_mass').value = 43.5;
    document.getElementById('cake_mo').value = 18.86;
    document.getElementById('cake_cu').value = 0.508;
    document.getElementById('cake_fe').value = 0.611;
    document.getElementById('cake_si').value = 1.74;
    document.getElementById('solution_mo').value = 6.5;
    document.getElementById('solution_cu').value = 2.58;
    document.getElementById('solution_fe').value = 3.01;
    document.getElementById('solution_si').value = 1.61;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –ø–æ–ª–µ–π
    document.getElementById('hno3_block').style.display = 'block';
    document.getElementById('h2so4_block').style.display = 'none';
    document.getElementById('oxygen_block').style.display = 'none';
}
</script>
{% endblock %}