{% extends 'base.html' %}
{% load static %}

{% block title %}–ú–æ–∏ —Ä–µ–∞–≥–µ–Ω—Ç—ã - –§–ª–æ—Ç–∞—Ü–∏—è{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/flotation.css' %}">
<style>
/* –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –°–¢–ò–õ–ò - –í –ï–î–ò–ù–û–ú –°–¢–ò–õ–ï –°–ê–ô–¢–ê */

/* –£–±–∏—Ä–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É */
.reagents-header {
    background: none;
    margin-top: 80px;
    padding: 4rem 2rem;
    text-align: center;
    position: relative;
}

.reagents-header::before {
    display: none;
}

.reagents-header h1 {
    font-size: 3rem;
    font-weight: 800;
    background: linear-gradient(45deg, var(--primary-blue), var(--primary-purple), var(--accent-gold));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: glow 2s ease-in-out infinite alternate;
    margin-bottom: 1rem;
}

.reagents-header p {
    font-size: 1.25rem;
    color: #cbd5e1;
    line-height: 1.6;
    margin-bottom: 2rem;
}

/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ —Å—Ç–∏–ª–µ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
.header-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 2rem;
    justify-content: center;
    max-width: 800px;
    margin: 0 auto;
}

.header-stat {
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    padding: 1.5rem;
    text-align: center;
    transition: all 0.3s ease;
}

.header-stat:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
}

.header-stat .stat-number {
    display: block;
    font-size: 2rem;
    font-weight: 800;
    color: var(--accent-gold);
    margin-bottom: 0.5rem;
}

.header-stat .stat-label {
    color: #cbd5e1;
    font-size: 0.9rem;
}

/* –ö–æ–Ω—Ç—Ä–æ–ª—ã –≤ —Å—Ç–∏–ª–µ —Å–∞–π—Ç–∞ */
.reagents-controls {
    padding: 2rem;
    max-width: 1200px;
    margin: 0 auto;
}

.info-panel {
    display: flex;
    gap: 2rem;
    justify-content: center;
    padding: 1rem;
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    margin-bottom: 2rem;
}

.info-item {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.info-label {
    color: #cbd5e1;
    font-size: 0.9rem;
}

.info-value {
    color: var(--accent-gold);
    font-weight: 600;
}

/* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å, –Ω–æ —É–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ —Ü–≤–µ—Ç–∞ */
.reagents-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 2rem;
    padding: 0 2rem 4rem;
    max-width: 1200px;
    margin: 0 auto;
}

/* –ö–∞—Ä—Ç–æ—á–∫–∏ —Ä–µ–∞–≥–µ–Ω—Ç–æ–≤ —É–∂–µ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Å—Ç–∏–ª–µ */
.reagent-card {
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 1.5rem;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.reagent-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--gradient-primary);
    transform: scaleX(0);
    transition: transform 0.3s ease;
}

.reagent-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    border-color: var(--accent-gold);
}

.reagent-card:hover::before {
    transform: scaleX(1);
}

/* –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç–∏–ª–µ–π */
</style>
{% endblock %}

{% block content %}
<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<section class="reagents-header">
    <div class="reagents-header-content">
        <h1>üß™ –ú–æ–∏ —Ä–µ–∞–≥–µ–Ω—Ç—ã</h1>
        <p>–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π —Ä–µ–∞–≥–µ–Ω—Ç–æ–≤, –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ —Å–º–µ—Å–∏ –¥–ª—è —Ñ–ª–æ—Ç–∞—Ü–∏–æ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤</p>
        
        <!-- –ë—ã—Å—Ç—Ä–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="header-stats">
            <div class="header-stat">
                <span class="stat-number">{{ reagent_stats.total }}</span>
                <span class="stat-label">–í—Å–µ–≥–æ —Ä–µ–∞–≥–µ–Ω—Ç–æ–≤</span>
            </div>
            <div class="header-stat">
                <span class="stat-number">{{ reagent_stats.experimental }}</span>
                <span class="stat-label">MP —Å–µ—Ä–∏—è</span>
            </div>
            <div class="header-stat">
                <span class="stat-number">{{ top_reagents.0.max_extraction|floatformat:1 }}%</span>
                <span class="stat-label">–õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</span>
            </div>
        </div>
    </div>
</section>

<!-- –ö–æ–Ω—Ç—Ä–æ–ª—ã: –ø–æ–∏—Å–∫, —Ñ–∏–ª—å—Ç—Ä—ã, –≤–∏–¥ -->
<section class="reagents-controls">
    <div class="controls-grid">
        <!-- –ü–æ–∏—Å–∫ -->
        <div class="search-box">
            <span class="search-icon">üîç</span>
            <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫ —Ä–µ–∞–≥–µ–Ω—Ç–æ–≤..." id="reagentSearch">
        </div>
        
        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="filter-tabs">
            {% for filter_type in reagent_types %}
            <button class="filter-tab {% if forloop.first %}active{% endif %}" data-filter="{{ filter_type.value }}">
                {{ filter_type.label }}
            </button>
            {% endfor %}
        </div>
        
        <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤–∏–¥–∞ -->
        <div class="view-toggle">
            <button class="view-btn active" data-view="grid" title="–°–µ—Ç–∫–∞">‚äû</button>
            <button class="view-btn" data-view="list" title="–°–ø–∏—Å–æ–∫">‚ò∞</button>
        </div>
    </div>
    
    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
    <div class="info-panel">
        <div class="info-item">
            <span class="info-label">–ù–∞–π–¥–µ–Ω–æ —Ä–µ–∞–≥–µ–Ω—Ç–æ–≤:</span>
            <span class="info-value" id="reagentsCount">{{ reagents.count }}</span>
        </div>
        <div class="info-item">
            <span class="info-label">–°—Ä–µ–¥–Ω—è—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</span>
            <span class="info-value">
            {% if reagents %}
                {% for reagent in reagents %}
                    {% if reagent.average_extraction %}
                        {{ reagent.average_extraction|floatformat:1 }}%
                    {% endif %}
                {% endfor %}
            {% else %}
                N/A
            {% endif %}
            </span>
        </div>
    </div>
</section>

<!-- –°–µ—Ç–∫–∞ —Ä–µ–∞–≥–µ–Ω—Ç–æ–≤ -->
<section class="reagents-grid" id="reagentsGrid">
    {% for reagent in reagents %}
    <div class="reagent-card {{ reagent.type }}" data-category="{{ reagent.type }}" data-name="{{ reagent.name|lower }}" data-tags="{% for tag in reagent.tags %}{{ tag.0|lower }} {% endfor %}">
        <div class="reagent-header">
            <div class="reagent-icon">{{ reagent.icon }}</div>
            <div class="reagent-info">
                <h3>{{ reagent.name }}</h3>
                <div class="reagent-type">{{ reagent.get_type_display }}</div>
            </div>
        </div>
        
        <p class="reagent-description">{{ reagent.description }}</p>
        
        <div class="reagent-properties">
            <div class="property">
                <span class="property-value">{{ reagent.dosage_range.main }}</span>
                <span class="property-label">–≥/—Ç {% if reagent.dosage_range.cleaner %}(–æ—Å–Ω–æ–≤–Ω–∞—è){% endif %}</span>
            </div>
            {% if reagent.dosage_range.cleaner %}
            <div class="property">
                <span class="property-value">{{ reagent.dosage_range.cleaner }}</span>
                <span class="property-label">–≥/—Ç (–ø–µ—Ä–µ—á–∏—Å—Ç–∫–∞)</span>
            </div>
            {% elif reagent.max_extraction %}
            <div class="property">
                <span class="property-value">{{ reagent.max_extraction|floatformat:1 }}%</span>
                <span class="property-label">–ú–∞–∫—Å. –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ</span>
            </div>
            {% elif reagent.working_ph_min and reagent.working_ph_max %}
            <div class="property">
                <span class="property-value">pH {{ reagent.working_ph_min|floatformat:0 }}-{{ reagent.working_ph_max|floatformat:0 }}</span>
                <span class="property-label">–†–∞–±–æ—á–∏–π pH</span>
            </div>
            {% endif %}
        </div>
        
        <div class="reagent-tags">
            {% for tag, css_class in reagent.tags %}
            <span class="tag {{ css_class }}">{{ tag }}</span>
            {% endfor %}
        </div>
        
        <div class="reagent-actions">
            <button class="action-btn" onclick="showReagentStats({{ reagent.id }}, '{{ reagent.name }}')">
                üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            </button>
            <button class="action-btn primary" onclick="addToMixture('{{ reagent.name }}', '{{ reagent.get_type_display }}', {{ reagent.id }})">
                ‚ûï –í —Å–º–µ—Å—å
            </button>
        </div>
    </div>
    {% empty %}
    <div class="empty-state">
        <div class="empty-state-icon">üß™</div>
        <h3>–†–µ–∞–≥–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
        <p>–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∞–≥–µ–Ω—Ç–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –∏—Ö —á–µ—Ä–µ–∑ –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.</p>
    </div>
    {% endfor %}
</section>

<!-- –ü–ª–∞–≤–∞—é—â–∞—è –ø–∞–Ω–µ–ª—å —Å–æ–∑–¥–∞–Ω–∏—è —Å–º–µ—Å–∏ -->
<div class="mixture-panel" id="mixturePanel" style="display: none;">
    <div class="mixture-content">
        <h3>üß™ –°–æ–∑–¥–∞–Ω–∏–µ —Å–º–µ—Å–∏</h3>
        <div class="mixture-reagents" id="mixtureReagents">
            <!-- –†–µ–∞–≥–µ–Ω—Ç—ã –≤ —Å–º–µ—Å–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ -->
        </div>
        <div class="mixture-stats" id="mixtureStats" style="display: none;">
            <div class="mixture-stat">
                <span>–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ:</span>
                <span id="predictedExtraction">--%</span>
            </div>
        </div>
        <div class="mixture-actions">
            <button class="btn btn-primary" onclick="calculateMixture()">
                –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
            </button>
            <button class="btn" onclick="clearMixture()">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ä–µ–∞–≥–µ–Ω—Ç–∞ -->
<div class="modal-overlay" id="reagentModal" style="display: none;" onclick="closeReagentModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 id="modalReagentName">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ–∞–≥–µ–Ω—Ç–∞</h3>
            <button class="modal-close" onclick="closeReagentModal()">√ó</button>
        </div>
        <div class="modal-body" id="modalReagentContent">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å–º–µ—Å—å—é
let currentMixture = [];
let reagentsData = {{ reagents|safe }}; // –î–∞–Ω–Ω—ã–µ —Ä–µ–∞–≥–µ–Ω—Ç–æ–≤ –∏–∑ Django

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    initializeReagentsPage();
});

function initializeReagentsPage() {
    setupFilters();
    setupSearch();
    setupViewToggle();
    updateReagentsCount();
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
function setupFilters() {
    const filterTabs = document.querySelectorAll('.filter-tab');
    const reagentCards = document.querySelectorAll('.reagent-card');
    
    filterTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö —Ç–∞–±–æ–≤
            filterTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            const filter = tab.dataset.filter;
            let visibleCount = 0;
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏
            reagentCards.forEach(card => {
                if (filter === 'all' || card.dataset.category === filter) {
                    card.style.display = 'block';
                    card.style.animation = 'fadeInUp 0.3s ease';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            
            updateReagentsCount(visibleCount);
            
            if (visibleCount === 0) {
                showEmptyState(`–ù–µ—Ç —Ä–µ–∞–≥–µ–Ω—Ç–æ–≤ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${tab.textContent}"`);
            } else {
                hideEmptyState();
            }
        });
    });
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–∏—Å–∫–∞
function setupSearch() {
    const searchInput = document.getElementById('reagentSearch');
    const reagentCards = document.querySelectorAll('.reagent-card');
    
    searchInput.addEventListener('input', MetallurgyLab.debounce((e) => {
        const searchTerm = e.target.value.toLowerCase();
        let visibleCount = 0;
        
        reagentCards.forEach(card => {
            const name = card.dataset.name || '';
            const tags = card.dataset.tags || '';
            const description = card.querySelector('.reagent-description').textContent.toLowerCase();
            
            const matches = name.includes(searchTerm) || 
                          description.includes(searchTerm) || 
                          tags.includes(searchTerm);
            
            if (matches || searchTerm === '') {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–∫–∂–µ –∞–∫—Ç–∏–≤–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä
                const activeFilter = document.querySelector('.filter-tab.active').dataset.filter;
                if (activeFilter === 'all' || card.dataset.category === activeFilter) {
                    card.style.display = 'block';
                    card.style.animation = 'fadeInUp 0.3s ease';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            } else {
                card.style.display = 'none';
            }
        });
        
        updateReagentsCount(visibleCount);
        
        if (visibleCount === 0 && searchTerm !== '') {
            showEmptyState(`–ù–µ –Ω–∞–π–¥–µ–Ω–æ —Ä–µ–∞–≥–µ–Ω—Ç–æ–≤ –ø–æ –∑–∞–ø—Ä–æ—Å—É "${searchTerm}"`);
        } else {
            hideEmptyState();
        }
    }, 300));
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è –≤–∏–¥–∞
function setupViewToggle() {
    const viewBtns = document.querySelectorAll('.view-btn');
    const reagentsGrid = document.getElementById('reagentsGrid');
    
    viewBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            viewBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            const view = btn.dataset.view;
            
            if (view === 'list') {
                reagentsGrid.style.gridTemplateColumns = '1fr';
                reagentsGrid.style.maxWidth = '800px';
                
                // –ú–µ–Ω—è–µ–º –º–∞–∫–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è —Å–ø–∏—Å–æ—á–Ω–æ–≥–æ –≤–∏–¥–∞
                document.querySelectorAll('.reagent-card').forEach(card => {
                    card.classList.add('list-view');
                });
            } else {
                reagentsGrid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(320px, 1fr))';
                reagentsGrid.style.maxWidth = '1200px';
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ã—á–Ω—ã–π –º–∞–∫–µ—Ç
                document.querySelectorAll('.reagent-card').forEach(card => {
                    card.classList.remove('list-view');
                });
            }
        });
    });
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∞–≥–µ–Ω—Ç–∞ –≤ —Å–º–µ—Å—å
function addToMixture(name, type, id) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –ª–∏ —É–∂–µ —ç—Ç–æ—Ç —Ä–µ–∞–≥–µ–Ω—Ç
    if (currentMixture.find(r => r.id === id)) {
        MetallurgyLab.showNotification(`${name} —É–∂–µ –≤ —Å–º–µ—Å–∏`, 'warning');
        return;
    }
    
    const reagent = { id, name, type };
    currentMixture.push(reagent);
    
    MetallurgyLab.showNotification(`${name} –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–º–µ—Å—å`, 'success');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —Å–º–µ—Å–∏
    const mixturePanel = document.getElementById('mixturePanel');
    mixturePanel.style.display = 'block';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–º–µ—Å–∏
    updateMixtureDisplay();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–º–µ—Å–∏
function updateMixtureDisplay() {
    const mixtureReagents = document.getElementById('mixtureReagents');
    mixtureReagents.innerHTML = '';
    
    currentMixture.forEach(reagent => {
        const reagentTag = document.createElement('div');
        reagentTag.className = 'mixture-reagent';
        reagentTag.innerHTML = `
            <span>${reagent.name}</span>
            <small>${reagent.type}</small>
            <button onclick="removeFromMixture(${reagent.id})">√ó</button>
        `;
        mixtureReagents.appendChild(reagentTag);
    });
}

// –£–¥–∞–ª–µ–Ω–∏–µ —Ä–µ–∞–≥–µ–Ω—Ç–∞ –∏–∑ —Å–º–µ—Å–∏
function removeFromMixture(reagentId) {
    currentMixture = currentMixture.filter(r => r.id !== reagentId);
    updateMixtureDisplay();
    
    if (currentMixture.length === 0) {
        document.getElementById('mixturePanel').style.display = 'none';
        document.getElementById('mixtureStats').style.display = 'none';
    }
}

// –û—á–∏—Å—Ç–∫–∞ —Å–º–µ—Å–∏
function clearMixture() {
    currentMixture = [];
    document.getElementById('mixtureReagents').innerHTML = '';
    document.getElementById('mixturePanel').style.display = 'none';
    document.getElementById('mixtureStats').style.display = 'none';
    MetallurgyLab.showNotification('–°–º–µ—Å—å –æ—á–∏—â–µ–Ω–∞', 'info');
}

// –†–∞—Å—á–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–º–µ—Å–∏
function calculateMixture() {
    if (currentMixture.length === 0) {
        MetallurgyLab.showNotification('–î–æ–±–∞–≤—å—Ç–µ —Ä–µ–∞–≥–µ–Ω—Ç—ã –≤ —Å–º–µ—Å—å', 'warning');
        return;
    }
    
    // –ü—Ä–æ—Å—Ç–∞—è –∏–º–∏—Ç–∞—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    // –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç AJAX –∑–∞–ø—Ä–æ—Å –∫ Django
    const avgEfficiency = 85 + Math.random() * 10; // –ò–º–∏—Ç–∞—Ü–∏—è
    
    document.getElementById('predictedExtraction').textContent = avgEfficiency.toFixed(1) + '%';
    document.getElementById('mixtureStats').style.display = 'block';
    
    MetallurgyLab.showNotification('–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞', 'success');
}

// –ü–æ–∫–∞–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ä–µ–∞–≥–µ–Ω—Ç–∞
function showReagentStats(reagentId, reagentName) {
    const modal = document.getElementById('reagentModal');
    const modalName = document.getElementById('modalReagentName');
    const modalContent = document.getElementById('modalReagentContent');
    
    modalName.textContent = `–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: ${reagentName}`;
    modalContent.innerHTML = `
        <div class="loading-placeholder">
            <div class="loading-spinner">‚ü≥</div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</p>
        </div>
    `;
    
    modal.style.display = 'flex';
    
    // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
    setTimeout(() => {
        modalContent.innerHTML = `
            <div class="stats-grid">
                <div class="stat-item">
                    <h4>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π –≤ —Ç–µ—Å—Ç–∞—Ö</h4>
                    <p class="stat-value">${Math.floor(Math.random() * 50 + 10)}</p>
                </div>
                <div class="stat-item">
                    <h4>–°—Ä–µ–¥–Ω–µ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ</h4>
                    <p class="stat-value">${(85 + Math.random() * 10).toFixed(1)}%</p>
                </div>
                <div class="stat-item">
                    <h4>–õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</h4>
                    <p class="stat-value">${(90 + Math.random() * 7).toFixed(1)}%</p>
                </div>
                <div class="stat-item">
                    <h4>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h4>
                    <p class="stat-value">${(80 + Math.random() * 15).toFixed(1)}%</p>
                </div>
            </div>
            <div class="chart-placeholder">
                <p>üìä –ì—Ä–∞—Ñ–∏–∫ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏</p>
                <small>(–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)</small>
            </div>
        `;
    }, 1000);
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function closeReagentModal() {
    document.getElementById('reagentModal').style.display = 'none';
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ —Ä–µ–∞–≥–µ–Ω—Ç–æ–≤
function updateReagentsCount(count) {
    const counter = document.getElementById('reagentsCount');
    if (counter) {
        counter.textContent = count !== undefined ? count : document.querySelectorAll('.reagent-card:not([style*="display: none"])').length;
    }
}

// –ü–æ–∫–∞–∑ –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
function showEmptyState(message = '–†–µ–∞–≥–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã') {
    let emptyState = document.querySelector('.empty-state-dynamic');
    if (!emptyState) {
        emptyState = document.createElement('div');
        emptyState.className = 'empty-state empty-state-dynamic';
        emptyState.innerHTML = `
            <div class="empty-state-icon">üîç</div>
            <h3>–†–µ–∞–≥–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
            <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∏–ª–∏ —Ñ–∏–ª—å—Ç—Ä—ã</p>
        `;
        document.getElementById('reagentsGrid').appendChild(emptyState);
    }
    emptyState.querySelector('h3').textContent = message;
    emptyState.style.display = 'block';
}

// –°–∫—Ä—ã—Ç–∏–µ –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
function hideEmptyState() {
    const emptyState = document.querySelector('.empty-state-dynamic');
    if (emptyState) {
        emptyState.style.display = 'none';
    }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeReagentModal();
    }
});
</script>

<!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è Django –≤–µ—Ä—Å–∏–∏ -->
<style>
/* –°—Ç–∏–ª–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
.header-stats {
    display: flex;
    gap: 2rem;
    justify-content: center;
    margin-top: 2rem;
}

.header-stat {
    text-align: center;
}

.header-stat .stat-number {
    display: block;
    font-size: 2rem;
    font-weight: 700;
    color: var(--accent-gold);
}

.header-stat .stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å */
.info-panel {
    display: flex;
    gap: 2rem;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    margin-bottom: 1rem;
}

.info-item {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.info-label {
    color: #94a3b8;
    font-size: 0.9rem;
}

.info-value {
    color: var(--accent-gold);
    font-weight: 600;
}

/* –°–ø–∏—Å–æ—á–Ω—ã–π –≤–∏–¥ */
.reagent-card.list-view {
    display: flex !important;
    align-items: center;
    gap: 2rem;
    padding: 1rem 2rem;
}

.reagent-card.list-view .reagent-header {
    margin-bottom: 0;
    min-width: 200px;
}

.reagent-card.list-view .reagent-description {
    flex: 1;
    margin-bottom: 0;
}

.reagent-card.list-view .reagent-properties {
    display: flex;
    gap: 1rem;
    margin-bottom: 0;
}

.reagent-card.list-view .reagent-actions {
    min-width: 180px;
}

/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: fadeIn 0.3s ease;
}

.modal-content {
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    animation: slideInUp 0.3s ease;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid var(--glass-border);
}

.modal-header h3 {
    color: var(--text-light);
    margin: 0;
}

.modal-close {
    background: none;
    border: none;
    color: var(--text-light);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.3s ease;
}

.modal-close:hover {
    background: rgba(255, 255, 255, 0.1);
}

.modal-body {
    padding: 1.5rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-item {
    text-align: center;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
}

.stat-item h4 {
    color: #94a3b8;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
}

.stat-item .stat-value {
    color: var(--accent-gold);
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0;
}

.chart-placeholder {
    text-align: center;
    padding: 2rem;
    background: rgba(255, 255, 255, 0.02);
    border-radius: 12px;
    border: 2px dashed rgba(255, 255, 255, 0.1);
}

.loading-placeholder {
    text-align: center;
    padding: 2rem;
}

.loading-spinner {
    font-size: 2rem;
    animation: spin 1s linear infinite;
    margin-bottom: 1rem;
}

/* –°–º–µ—Å—å —Ä–µ–∞–≥–µ–Ω—Ç–æ–≤ */
.mixture-reagent {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: var(--accent-gold);
    color: var(--dark-bg);
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 500;
}

.mixture-reagent small {
    opacity: 0.8;
    font-size: 0.8rem;
}

.mixture-reagent button {
    background: none;
    border: none;
    color: inherit;
    font-size: 1.1rem;
    cursor: pointer;
    padding: 0;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background 0.3s ease;
    margin-left: auto;
}

.mixture-reagent button:hover {
    background: rgba(0, 0, 0, 0.1);
}

.mixture-stats {
    margin: 1rem 0;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
}

.mixture-stat {
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: var(--text-light);
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideInUp {
    from { transform: translateY(30px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}
</style>
{% endblock %}