{% extends 'base.html' %}
{% load static %}

{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ñ–ª–æ—Ç–∞—Ü–∏–∏ - Metallurgy Lab{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/flotation.css' %}">
<style>
.analytics-container {
    margin-top: 80px;
    padding: 2rem;
    max-width: 1400px;
    margin-left: auto;
    margin-right: auto;
}

.analytics-hero {
    text-align: center;
    margin-bottom: 3rem;
    margin-top: 5rem;
}

.analytics-title {
    font-size: 3rem;
    font-weight: 800;
    background: linear-gradient(45deg, var(--primary-blue), var(--primary-purple), var(--accent-gold));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: glow 2s ease-in-out infinite alternate;
    margin-bottom: 1rem;
    padding-top: 2rem;
}

.analytics-subtitle {
    font-size: 1.25rem;
    color: #cbd5e1;
    line-height: 1.6;
    max-width: 800px;
    margin: 0 auto;
}

/* –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ */
.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
    margin-bottom: 3rem;
}

.metric-card {
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 2rem;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.metric-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--gradient-primary);
    transform: scaleX(0);
    transition: transform 0.3s ease;
}

.metric-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    border-color: var(--accent-gold);
}

.metric-card:hover::before {
    transform: scaleX(1);
}

.metric-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    display: block;
}

.metric-value {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--accent-gold);
    margin-bottom: 0.5rem;
}

.metric-label {
    color: var(--text-light);
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.metric-description {
    color: #94a3b8;
    font-size: 0.9rem;
}

/* –°–µ–∫—Ü–∏–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ */
.analytics-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-bottom: 2rem;
}

.analytics-section {
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 2rem;
    transition: all 0.3s ease;
}

.analytics-section:hover {
    transform: translateY(-3px);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.section-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-light);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.section-subtitle {
    color: #94a3b8;
    font-size: 0.9rem;
}

/* –ì—Ä–∞—Ñ–∏–∫–∏ */
.chart-container {
    position: relative;
    height: 300px;
    margin-bottom: 1rem;
}

.chart-canvas {
    background: rgba(255, 255, 255, 0.02);
    border-radius: 12px;
}

/* –¢–∞–±–ª–∏—Ü—ã –¥–∞–Ω–Ω—ã—Ö */
.data-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
}

.data-table th,
.data-table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.data-table th {
    background: rgba(255, 255, 255, 0.05);
    color: var(--accent-gold);
    font-weight: 600;
    font-size: 0.9rem;
}

.data-table td {
    color: var(--text-light);
}

.data-table tbody tr:hover {
    background: rgba(255, 255, 255, 0.05);
}

/* –ö–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
.stats-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
}

.stat-item:hover {
    background: rgba(255, 255, 255, 0.06);
    border-color: var(--accent-gold);
    transform: translateX(5px);
}

.stat-item-info h4 {
    color: var(--text-light);
    margin-bottom: 0.25rem;
    font-size: 1rem;
}

.stat-item-meta {
    color: #94a3b8;
    font-size: 0.8rem;
}

.stat-item-value {
    text-align: right;
}

.stat-value-main {
    color: var(--accent-gold);
    font-weight: 600;
    font-size: 1.2rem;
}

.stat-value-sub {
    color: #94a3b8;
    font-size: 0.8rem;
}

/* –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ */
.efficiency-categories {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-top: 1rem;
}

.efficiency-category {
    padding: 1rem;
    border-radius: 12px;
    text-align: center;
    border: 2px solid;
    transition: transform 0.3s ease;
}

.efficiency-category:hover {
    transform: scale(1.05);
}

.category-excellent {
    background: rgba(34, 197, 94, 0.1);
    border-color: #22c55e;
}

.category-good {
    background: rgba(59, 130, 246, 0.1);
    border-color: #3b82f6;
}

.category-average {
    background: rgba(251, 191, 36, 0.1);
    border-color: #fbbf24;
}

.category-poor {
    background: rgba(239, 68, 68, 0.1);
    border-color: #ef4444;
}

.category-count {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.category-label {
    font-size: 0.9rem;
    font-weight: 600;
}

.category-percentage {
    font-size: 0.8rem;
    opacity: 0.8;
}

/* –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ */
.process-comparison {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-top: 1rem;
}

.process-card {
    padding: 1.5rem;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    text-align: center;
}

.process-title {
    color: var(--accent-gold);
    font-weight: 600;
    margin-bottom: 1rem;
}

.process-stats {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.process-stat {
    display: flex;
    justify-content: space-between;
    font-size: 0.9rem;
}

.process-stat-label {
    color: #94a3b8;
}

.process-stat-value {
    color: var(--text-light);
    font-weight: 600;
}

/* –ü–æ–ª–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–µ —Å–µ–∫—Ü–∏–∏ */
.full-width-section {
    grid-column: 1 / -1;
}

/* –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */
.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: #94a3b8;
}

.empty-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.empty-title {
    font-size: 1.5rem;
    color: var(--text-light);
    margin-bottom: 1rem;
}

.empty-description {
    margin-bottom: 2rem;
    line-height: 1.6;
}

.btn-primary {
    background: var(--gradient-primary);
    color: white;
    padding: 1rem 2rem;
    border: none;
    border-radius: 25px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    color: white;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 1024px) {
    .analytics-grid {
        grid-template-columns: 1fr;
    }
    
    .efficiency-categories {
        grid-template-columns: 1fr;
    }
    
    .process-comparison {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .metrics-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .analytics-title {
        font-size: 2.5rem;
    }
}

@media (max-width: 480px) {
    .metrics-grid {
        grid-template-columns: 1fr;
    }
    
    .analytics-title {
        font-size: 2rem;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Hero —Å–µ–∫—Ü–∏—è -->
<section class="analytics-hero">
    <h1 class="analytics-title">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ñ–ª–æ—Ç–∞—Ü–∏–∏</h1>
    <p class="analytics-subtitle">
        –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ñ–ª–æ—Ç–∞—Ü–∏–æ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, —Ç—Ä–µ–Ω–¥–æ–≤ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∏ —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
    </p>
</section>

{% if no_data %}
<!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
<section class="empty-state">
    <div class="empty-icon">üìä</div>
    <h2 class="empty-title">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</h2>
    <p class="empty-description">
        –î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∑–¥–∞—Ç—å —Ñ–ª–æ—Ç–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã. 
        –ù–∞—á–Ω–∏—Ç–µ —Å —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä–≤–æ–≥–æ —Ç–µ—Å—Ç–∞ —á–µ—Ä–µ–∑ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ñ–ª–æ—Ç–∞—Ü–∏–∏.
    </p>
    <a href="{% url 'flotation:calculator' %}" class="btn-primary">
        üßÆ –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π —Ç–µ—Å—Ç
    </a>
</section>

{% else %}

<!-- –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ -->
<section class="metrics-grid">
    <div class="metric-card">
        <span class="metric-icon">üß™</span>
        <div class="metric-value">{{ total_tests }}</div>
        <div class="metric-label">–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤</div>
        <div class="metric-description">–ü—Ä–æ–≤–µ–¥–µ–Ω–æ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤</div>
    </div>
    
    <div class="metric-card">
        <span class="metric-icon">üìà</span>
        <div class="metric-value">{{ avg_extraction|floatformat:1 }}%</div>
        <div class="metric-label">–°—Ä–µ–¥–Ω–µ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ</div>
        <div class="metric-description">–ü–æ –≤—Å–µ–º —Ç–µ—Å—Ç–∞–º</div>
    </div>
    
    <div class="metric-card">
        <span class="metric-icon">‚ö°</span>
        <div class="metric-value">{{ avg_efficiency|floatformat:1 }}%</div>
        <div class="metric-label">–°—Ä–µ–¥–Ω—è—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
        <div class="metric-description">–û–±–æ–≥–∞—â–µ–Ω–∏—è</div>
    </div>
    
    <div class="metric-card">
        <span class="metric-icon">üéØ</span>
        <div class="metric-value">{{ success_rate|floatformat:0 }}%</div>
        <div class="metric-label">–£—Å–ø–µ—à–Ω–æ—Å—Ç—å</div>
        <div class="metric-description">–¢–µ—Å—Ç—ã —Å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ–º ‚â•85%</div>
    </div>
    
    <div class="metric-card">
        <span class="metric-icon">üèÜ</span>
        <div class="metric-value">{{ best_test.extraction|floatformat:1 }}%</div>
        <div class="metric-label">–õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
        <div class="metric-description">–¢–µ—Å—Ç ‚Ññ{{ best_test.number }}</div>
    </div>
    
    <div class="metric-card">
        <span class="metric-icon">üìâ</span>
        <div class="metric-value">{{ worst_test.extraction|floatformat:1 }}%</div>
        <div class="metric-label">–•—É–¥—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
        <div class="metric-description">–¢–µ—Å—Ç ‚Ññ{{ worst_test.number }}</div>
    </div>
</section>

<!-- –û—Å–Ω–æ–≤–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
<section class="analytics-grid">
    <!-- –¢—Ä–µ–Ω–¥ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è -->
    <div class="analytics-section">
        <div class="section-header">
            <div>
                <h3 class="section-title">üìà –¢—Ä–µ–Ω–¥ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π</h3>
                <p class="section-subtitle">–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 20 —Ç–µ—Å—Ç–æ–≤</p>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="trendChart" class="chart-canvas"></canvas>
        </div>
    </div>

    <!-- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
    <div class="analytics-section">
        <div class="section-header">
            <div>
                <h3 class="section-title">üéØ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—é</h3>
                <p class="section-subtitle">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</p>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="extractionHistogram" class="chart-canvas"></canvas>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è–º -->
    <div class="analytics-section">
        <div class="section-header">
            <div>
                <h3 class="section-title">üîß –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π</h3>
                <p class="section-subtitle">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</p>
            </div>
        </div>
        
        <div class="stats-list">
            {% for config in extraction_by_config %}
            <div class="stat-item">
                <div class="stat-item-info">
                    <h4>{{ config.configuration }}</h4>
                    <div class="stat-item-meta">
                        {{ config.count }} —Ç–µ—Å—Ç{{ config.count|pluralize:"–æ–≤" }}
                        ‚Ä¢ –ú–∞–∫—Å: {{ config.max_extraction|floatformat:1 }}%
                        ‚Ä¢ –ú–∏–Ω: {{ config.min_extraction|floatformat:1 }}%
                    </div>
                </div>
                <div class="stat-item-value">
                    <div class="stat-value-main">{{ config.avg_extraction|floatformat:1 }}%</div>
                    <div class="stat-value-sub">—Å—Ä–µ–¥–Ω–µ–µ</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- –ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π -->
    <div class="analytics-section">
        <div class="section-header">
            <div>
                <h3 class="section-title">ü•ß –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π</h3>
                <p class="section-subtitle">–î–æ–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</p>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="configPieChart" class="chart-canvas"></canvas>
        </div>
    </div>

    <!-- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ -->
    <div class="analytics-section full-width-section">
        <div class="section-header">
            <div>
                <h3 class="section-title">‚öñÔ∏è –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤</h3>
                <p class="section-subtitle">–ú–∏–∫—Ä–æ—Ñ–ª–æ—Ç–∞—Ü–∏—è vs –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Ñ–ª–æ—Ç–∞—Ü–∏—è</p>
            </div>
        </div>
        
        <div class="process-comparison">
            <div class="process-card">
                <div class="process-title">üî¨ –ú–∏–∫—Ä–æ—Ñ–ª–æ—Ç–∞—Ü–∏—è</div>
                <div class="process-stats">
                    <div class="process-stat">
                        <span class="process-stat-label">–¢–µ—Å—Ç–æ–≤:</span>
                        <span class="process-stat-value">{{ process_comparison.microflotation.count }}</span>
                    </div>
                    <div class="process-stat">
                        <span class="process-stat-label">–°—Ä–µ–¥–Ω–µ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ:</span>
                        <span class="process-stat-value">{{ process_comparison.microflotation.avg_extraction|floatformat:1 }}%</span>
                    </div>
                    <div class="process-stat">
                        <span class="process-stat-label">–°—Ä–µ–¥–Ω—è—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</span>
                        <span class="process-stat-value">{{ process_comparison.microflotation.avg_efficiency|floatformat:1 }}%</span>
                    </div>
                    <div class="process-stat">
                        <span class="process-stat-label">–ú–∞–∫—Å–∏–º—É–º:</span>
                        <span class="process-stat-value">{{ process_comparison.microflotation.max_extraction|floatformat:1 }}%</span>
                    </div>
                    <div class="process-stat">
                        <span class="process-stat-label">–ú–∏–Ω–∏–º—É–º:</span>
                        <span class="process-stat-value">{{ process_comparison.microflotation.min_extraction|floatformat:1 }}%</span>
                    </div>
                </div>
            </div>
            
            <div class="process-card">
                <div class="process-title">‚öóÔ∏è –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Ñ–ª–æ—Ç–∞—Ü–∏—è</div>
                <div class="process-stats">
                    <div class="process-stat">
                        <span class="process-stat-label">–¢–µ—Å—Ç–æ–≤:</span>
                        <span class="process-stat-value">{{ process_comparison.standard.count }}</span>
                    </div>
                    <div class="process-stat">
                        <span class="process-stat-label">–°—Ä–µ–¥–Ω–µ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ:</span>
                        <span class="process-stat-value">{{ process_comparison.standard.avg_extraction|floatformat:1 }}%</span>
                    </div>
                    <div class="process-stat">
                        <span class="process-stat-label">–°—Ä–µ–¥–Ω—è—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</span>
                        <span class="process-stat-value">{{ process_comparison.standard.avg_efficiency|floatformat:1 }}%</span>
                    </div>
                    <div class="process-stat">
                        <span class="process-stat-label">–ú–∞–∫—Å–∏–º—É–º:</span>
                        <span class="process-stat-value">{{ process_comparison.standard.max_extraction|floatformat:1 }}%</span>
                    </div>
                    <div class="process-stat">
                        <span class="process-stat-label">–ú–∏–Ω–∏–º—É–º:</span>
                        <span class="process-stat-value">{{ process_comparison.standard.min_extraction|floatformat:1 }}%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
    <div class="analytics-section">
        <div class="section-header">
            <div>
                <h3 class="section-title">üìä –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h3>
                <p class="section-subtitle">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤ –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º</p>
            </div>
        </div>
        
        <div class="efficiency-categories">
            <div class="efficiency-category category-excellent">
                <div class="category-count">{{ efficiency_categories.excellent.count }}</div>
                <div class="category-label">–û—Ç–ª–∏—á–Ω—ã–µ</div>
                <div class="category-percentage">‚â•90% ({{ efficiency_categories.excellent.percentage|floatformat:0 }}%)</div>
            </div>
            
            <div class="efficiency-category category-good">
                <div class="category-count">{{ efficiency_categories.good.count }}</div>
                <div class="category-label">–•–æ—Ä–æ—à–∏–µ</div>
                <div class="category-percentage">80-89% ({{ efficiency_categories.good.percentage|floatformat:0 }}%)</div>
            </div>
            
            <div class="efficiency-category category-average">
                <div class="category-count">{{ efficiency_categories.average.count }}</div>
                <div class="category-label">–°—Ä–µ–¥–Ω–∏–µ</div>
                <div class="category-percentage">70-79% ({{ efficiency_categories.average.percentage|floatformat:0 }}%)</div>
            </div>
            
            <div class="efficiency-category category-poor">
                <div class="category-count">{{ efficiency_categories.poor.count }}</div>
                <div class="category-label">–°–ª–∞–±—ã–µ</div>
                <div class="category-percentage"><70% ({{ efficiency_categories.poor.percentage|floatformat:0 }}%)</div>
            </div>
        </div>
    </div>

    <!-- –ê–Ω–∞–ª–∏–∑ —Ä–µ–∞–≥–µ–Ω—Ç–æ–≤ -->
    <div class="analytics-section">
        <div class="section-header">
            <div>
                <h3 class="section-title">üß™ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ä–µ–∞–≥–µ–Ω—Ç–æ–≤</h3>
                <p class="section-subtitle">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–∞–≥–µ–Ω—Ç–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤</p>
            </div>
        </div>
        
        {% if reagent_effectiveness %}
        <div class="stats-list">
            {% for reagent in reagent_effectiveness %}
            <div class="stat-item">
                <div class="stat-item-info">
                    <h4>{{ reagent.reagent }}</h4>
                    <div class="stat-item-meta">{{ reagent.count }} —Ç–µ—Å—Ç{{ reagent.count|pluralize:"–æ–≤" }}</div>
                </div>
                <div class="stat-item-value">
                    <div class="stat-value-main">{{ reagent.avg_extraction|floatformat:1 }}%</div>
                    <div class="stat-value-sub">—Å—Ä–µ–¥–Ω–µ–µ</div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div style="text-align: center; padding: 2rem; color: #94a3b8;">
            <p>–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–∞–≥–µ–Ω—Ç–æ–≤</p>
        </div>
        {% endif %}
    </div>

    <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç–µ—Å—Ç—ã -->
    <div class="analytics-section full-width-section">
        <div class="section-header">
            <div>
                <h3 class="section-title">üïí –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç–µ—Å—Ç—ã</h3>
                <p class="section-subtitle">10 –Ω–µ–¥–∞–≤–Ω–∏—Ö —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤</p>
            </div>
            <a href="{% url 'flotation:tests' %}" style="color: var(--accent-gold); text-decoration: none;">
                –í—Å–µ —Ç–µ—Å—Ç—ã ‚Üí
            </a>
        </div>
        
        {% if recent_tests %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>‚Ññ</th>
                    <th>–¢–∏–ø</th>
                    <th>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</th>
                    <th>–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ</th>
                    <th>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
                    <th>–í—ã—Ö–æ–¥</th>
                    <th>–î–∞—Ç–∞</th>
                </tr>
            </thead>
            <tbody>
                {% for test in recent_tests %}
                <tr>
                    <td style="font-weight: 600; color: var(--accent-gold);">{{ test.number }}</td>
                    <td>
                        {% if test.is_microflotation %}
                            <span style="color: #3b82f6;">üî¨ –ú–∏–∫—Ä–æ</span>
                        {% else %}
                            <span style="color: #10b981;">‚öóÔ∏è –°—Ç–∞–Ω–¥–∞—Ä—Ç</span>
                        {% endif %}
                    </td>
                    <td>{{ test.configuration|default:"‚Äî" }}</td>
                    <td>
                        <span style="font-weight: 600; 
                            {% if test.extraction >= 90 %}color: #10b981;
                            {% elif test.extraction >= 80 %}color: #3b82f6;
                            {% elif test.extraction >= 70 %}color: #f59e0b;
                            {% else %}color: #ef4444;{% endif %}">
                            {{ test.extraction|floatformat:1 }}%
                        </span>
                    </td>
                    <td>{{ test.efficiency|floatformat:1 }}%</td>
                    <td>{{ test.concentrate_yield|floatformat:1 }}%</td>
                    <td style="color: #94a3b8;">{{ test.date_conducted|date:"d.m.Y" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div style="text-align: center; padding: 2rem; color: #94a3b8;">
            <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ç–µ—Å—Ç–∞—Ö</p>
        </div>
        {% endif %}
    </div>

    <!-- –¢–æ–ø —Ç–µ—Å—Ç—ã -->
    {% if excellent_tests %}
    <div class="analytics-section">
        <div class="section-header">
            <div>
                <h3 class="section-title">üèÜ –õ—É—á—à–∏–µ —Ç–µ—Å—Ç—ã</h3>
                <p class="section-subtitle">–¢–æ–ø 5 –ø–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—é</p>
            </div>
        </div>
        
        <div class="stats-list">
            {% for test in excellent_tests %}
            <div class="stat-item">
                <div class="stat-item-info">
                    <h4>–¢–µ—Å—Ç ‚Ññ{{ test.number }}</h4>
                    <div class="stat-item-meta">
                        {{ test.configuration|default:"–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è" }}
                        ‚Ä¢ {% if test.is_microflotation %}–ú–∏–∫—Ä–æ—Ñ–ª–æ—Ç–∞—Ü–∏—è{% else %}–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è{% endif %}
                    </div>
                </div>
                <div class="stat-item-value">
                    <div class="stat-value-main">{{ test.extraction|floatformat:1 }}%</div>
                    <div class="stat-value-sub">{{ test.efficiency|floatformat:1 }}% —ç—Ñ—Ñ</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —Ç–µ—Å—Ç—ã -->
    {% if poor_tests %}
    <div class="analytics-section">
        <div class="section-header">
            <div>
                <h3 class="section-title">‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —Ç–µ—Å—Ç—ã</h3>
                <p class="section-subtitle">–¢—Ä–µ–±—É—é—Ç –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–∏—á–∏–Ω</p>
            </div>
        </div>
        
        <div class="stats-list">
            {% for test in poor_tests %}
            <div class="stat-item">
                <div class="stat-item-info">
                    <h4>–¢–µ—Å—Ç ‚Ññ{{ test.number }}</h4>
                    <div class="stat-item-meta">
                        {{ test.configuration|default:"–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è" }}
                        ‚Ä¢ {{ test.date_conducted|date:"d.m.Y" }}
                    </div>
                </div>
                <div class="stat-item-value">
                    <div class="stat-value-main" style="color: #ef4444;">{{ test.extraction|floatformat:1 }}%</div>
                    <div class="stat-value-sub">–Ω–∏–∑–∫–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</section>

{% endif %}

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Chart.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script>
// –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∏–∑ Django
const trendData = {{ trend_chart_data|safe }};
const pieData = {{ config_pie_data|safe }};
const histogramData = {{ extraction_histogram_data|safe }};

// –ì–†–ê–§–ò–ö –¢–†–ï–ù–î–ê –ü–û–ö–ê–ó–ê–¢–ï–õ–ï–ô
if (document.getElementById('trendChart')) {
    const trendCtx = document.getElementById('trendChart').getContext('2d');
    const trendChart = new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: trendData.labels,
            datasets: [
                {
                    label: '–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ (%)',
                    data: trendData.extraction_data,
                    borderColor: '#10B981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#10B981',
                    pointBorderColor: '#1e293b',
                    pointBorderWidth: 2,
                    pointRadius: 5
                },
                {
                    label: '–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (%)',
                    data: trendData.efficiency_data,
                    borderColor: '#3B82F6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.4,
                    pointBackgroundColor: '#3B82F6',
                    pointBorderColor: '#1e293b',
                    pointBorderWidth: 2,
                    pointRadius: 4
                },
                {
                    label: '–í—ã—Ö–æ–¥ (%)',
                    data: trendData.yield_data,
                    borderColor: '#F59E0B',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.4,
                    pointBackgroundColor: '#F59E0B',
                    pointBorderColor: '#1e293b',
                    pointBorderWidth: 2,
                    pointRadius: 4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: '#cbd5e1',
                        usePointStyle: true,
                        padding: 20
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(30, 41, 59, 0.9)',
                    titleColor: '#FFD700',
                    bodyColor: '#cbd5e1',
                    borderColor: '#FFD700',
                    borderWidth: 1
                }
            },
            scales: {
                x: {
                    ticks: {
                        color: '#94a3b8',
                        maxTicksLimit: 10
                    },
                    grid: {
                        color: 'rgba(148, 163, 184, 0.1)'
                    }
                },
                y: {
                    ticks: {
                        color: '#94a3b8',
                        callback: function(value) {
                            return value + '%';
                        }
                    },
                    grid: {
                        color: 'rgba(148, 163, 184, 0.1)'
                    },
                    min: 0,
                    max: 100
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
}

// –ö–†–£–ì–û–í–ê–Ø –î–ò–ê–ì–†–ê–ú–ú–ê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ô
if (document.getElementById('configPieChart')) {
    const pieCtx = document.getElementById('configPieChart').getContext('2d');
    const pieChart = new Chart(pieCtx, {
        type: 'doughnut',
        data: {
            labels: pieData.labels,
            datasets: [{
                data: pieData.data,
                backgroundColor: pieData.colors,
                borderColor: '#1e293b',
                borderWidth: 2,
                hoverBorderWidth: 3,
                hoverBorderColor: '#FFD700'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#cbd5e1',
                        padding: 20,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(30, 41, 59, 0.9)',
                    titleColor: '#FFD700',
                    bodyColor: '#cbd5e1',
                    borderColor: '#FFD700',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                        }
                    }
                }
            },
            cutout: '60%'
        }
    });
}

// –ì–ò–°–¢–û–ì–†–ê–ú–ú–ê –ò–ó–í–õ–ï–ß–ï–ù–ò–Ø
if (document.getElementById('extractionHistogram')) {
    const histCtx = document.getElementById('extractionHistogram').getContext('2d');
    const histChart = new Chart(histCtx, {
        type: 'bar',
        data: {
            labels: histogramData.labels,
            datasets: [{
                label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–µ—Å—Ç–æ–≤',
                data: histogramData.data,
                backgroundColor: histogramData.colors,
                borderColor: histogramData.colors.map(color => color.replace('0.8', '1')),
                borderWidth: 2,
                borderRadius: 8,
                borderSkipped: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(30, 41, 59, 0.9)',
                    titleColor: '#FFD700',
                    bodyColor: '#cbd5e1',
                    borderColor: '#FFD700',
                    borderWidth: 1
                }
            },
            scales: {
                x: {
                    ticks: {
                        color: '#94a3b8'
                    },
                    grid: {
                        color: 'rgba(148, 163, 184, 0.1)'
                    }
                },
                y: {
                    ticks: {
                        color: '#94a3b8',
                        stepSize: 1
                    },
                    grid: {
                        color: 'rgba(148, 163, 184, 0.1)'
                    },
                    beginAtZero: true
                }
            }
        }
    });
}

// –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    // –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
    const metricCards = document.querySelectorAll('.metric-card');
    metricCards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        setTimeout(() => {
            card.style.transition = 'all 0.6s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
    
    // –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ —Å–µ–∫—Ü–∏–π
    const sections = document.querySelectorAll('.analytics-section');
    sections.forEach((section, index) => {
        setTimeout(() => {
            section.style.opacity = '0';
            section.style.transform = 'translateY(30px)';
            section.style.transition = 'all 0.8s ease';
            
            setTimeout(() => {
                section.style.opacity = '1';
                section.style.transform = 'translateY(0)';
            }, 200);
        }, index * 150);
    });
});
</script>

{% endblock %}